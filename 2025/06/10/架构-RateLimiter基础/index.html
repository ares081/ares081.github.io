<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  
  <title>RateLimiter算法与使用 | Ares&#39;s Notes</title>
  <meta name="author" content="ares">
  
  <meta name="description" content="服务降级是服务自我保护的一种方式，或者保护下游服务的一种方式，用于确保服务不会受请求突增影响变得不可用，至少确保服务不会奔溃。常见的服务降级实现方式有：开关降级、限流降级、熔断降级。
基础限流算法
令牌桶算法（Token Bucket）
漏桶算法（Leaky Bucket）
滑动窗口算法（Sliding Window）
计数器算法（Fixed Window Counter）">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="RateLimiter算法与使用"/>
  <meta property="og:site_name" content="Ares&#39;s Notes"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	ga('create', 'G-RL5NX8NL9X', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 8.1.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Ares&#39;s Notes</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-架构-RateLimiter基础" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2025-06-10T07:51:26.000Z"><a href="/2025/06/10/%E6%9E%B6%E6%9E%84-RateLimiter%E5%9F%BA%E7%A1%80/">2025-06-10</a></time>
      
      
  
    <h1 class="p-name title" itemprop="headline name">RateLimiter算法与使用</h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p><font color = blue>服务降级是服务自我保护的一种方式，或者保护下游服务的一种方式，用于确保服务不会受请求突增影响变得不可用，至少确保服务不会奔溃。常见的服务降级实现方式有：<strong>开关降级、限流降级、熔断降级</strong>。</font></p>
<h2 id="基础限流算法"><a href="#基础限流算法" class="headerlink" title="基础限流算法"></a>基础限流算法</h2><ul>
<li>令牌桶算法（Token Bucket）</li>
<li>漏桶算法（Leaky Bucket）</li>
<li>滑动窗口算法（Sliding Window）</li>
<li>计数器算法（Fixed Window Counter）</li>
</ul>
<span id="more"></span>

<h3 id="令牌桶算法（Token-Bucket）"><a href="#令牌桶算法（Token-Bucket）" class="headerlink" title="令牌桶算法（Token Bucket）"></a>令牌桶算法（Token Bucket）</h3><p>系统以固定速率向桶中放入令牌，请求需要先获取令牌才能被处理：</p>
<ul>
<li>可以应对突发流量</li>
<li>具有缓冲能力</li>
<li>实现相对简单</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenBucketLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;           <span class="comment">// 桶的容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> refillTokensPerSecond;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> availableTokens;        <span class="comment">// 当前令牌数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastRefillTimestamp;      </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenBucketLimiter</span><span class="params">(<span class="type">long</span> capacity, <span class="type">double</span> refillTokensPerSecond)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.refillTokensPerSecond = refillTokensPerSecond;</span><br><span class="line">        <span class="built_in">this</span>.availableTokens = capacity;</span><br><span class="line">        <span class="built_in">this</span>.lastRefillTimestamp = System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span> &#123;</span><br><span class="line">        refill();</span><br><span class="line">        <span class="keyword">if</span> (availableTokens &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            availableTokens -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refill</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">double</span> <span class="variable">tokensToAdd</span> <span class="operator">=</span> (now - lastRefillTimestamp) * refillTokensPerSecond / <span class="number">1e9</span>;</span><br><span class="line">        availableTokens = Math.min(capacity, availableTokens + tokensToAdd);</span><br><span class="line">        lastRefillTimestamp = now;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="漏桶算法（Leaky-Bucket）"><a href="#漏桶算法（Leaky-Bucket）" class="headerlink" title="漏桶算法（Leaky Bucket）"></a>漏桶算法（Leaky Bucket）</h3><p>请求先进入到漏桶，漏桶以固定的速率处理请求。</p>
<ul>
<li>控制流量的平滑性好</li>
<li>无法应对突发流量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyBucketLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;           <span class="comment">// 桶的容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> leakRatePerSecond;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> currentVolume;          <span class="comment">// 当前水量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastLeakTimestamp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeakyBucketLimiter</span><span class="params">(<span class="type">long</span> capacity, <span class="type">double</span> leakRatePerSecond)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.leakRatePerSecond = leakRatePerSecond;</span><br><span class="line">        <span class="built_in">this</span>.currentVolume = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.lastLeakTimestamp = System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span> &#123;</span><br><span class="line">        leak();</span><br><span class="line">        <span class="keyword">if</span> (currentVolume &lt; capacity) &#123;</span><br><span class="line">            currentVolume++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">leak</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">double</span> <span class="variable">timeElapsed</span> <span class="operator">=</span> (now - lastLeakTimestamp) / <span class="number">1e9</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">leakedVolume</span> <span class="operator">=</span> timeElapsed * leakRatePerSecond;</span><br><span class="line">        currentVolume = Math.max(<span class="number">0</span>, currentVolume - leakedVolume);</span><br><span class="line">        lastLeakTimestamp = now;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="滑动窗口算法（Sliding-Window）"><a href="#滑动窗口算法（Sliding-Window）" class="headerlink" title="滑动窗口算法（Sliding Window）"></a>滑动窗口算法（Sliding Window）</h3><p>将时间划分为多个小窗口，统计每个窗口内的请求数。</p>
<ul>
<li>相比固定窗口更平滑</li>
<li>能够避免临界问题</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> windowSizeInSeconds;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxRequestsPerWindow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Long&gt; requestTimestamps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowLimiter</span><span class="params">(<span class="type">int</span> windowSizeInSeconds, <span class="type">int</span> maxRequestsPerWindow)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.windowSizeInSeconds = windowSizeInSeconds;</span><br><span class="line">        <span class="built_in">this</span>.maxRequestsPerWindow = maxRequestsPerWindow;</span><br><span class="line">        <span class="built_in">this</span>.requestTimestamps = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">windowStart</span> <span class="operator">=</span> currentTime - (windowSizeInSeconds * <span class="number">1000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 移除窗口外的请求记录</span></span><br><span class="line">        <span class="keyword">while</span> (!requestTimestamps.isEmpty() &amp;&amp; requestTimestamps.peek() &lt;= windowStart) &#123;</span><br><span class="line">            requestTimestamps.poll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestTimestamps.size() &lt; maxRequestsPerWindow) &#123;</span><br><span class="line">            requestTimestamps.offer(currentTime);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="计数器算法（Fixed-Window-Counter）"><a href="#计数器算法（Fixed-Window-Counter）" class="headerlink" title="计数器算法（Fixed Window Counter）"></a>计数器算法（Fixed Window Counter）</h3><p>在固定时间窗口内统计请求数量。</p>
<ul>
<li>实现最简单</li>
<li>可能存在临界问题</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedWindowLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxRequestsPerWindow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> windowSizeInMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> windowStart;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> currentCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FixedWindowLimiter</span><span class="params">(<span class="type">int</span> maxRequestsPerWindow, <span class="type">long</span> windowSizeInMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxRequestsPerWindow = maxRequestsPerWindow;</span><br><span class="line">        <span class="built_in">this</span>.windowSizeInMillis = windowSizeInMillis;</span><br><span class="line">        <span class="built_in">this</span>.windowStart = System.currentTimeMillis();</span><br><span class="line">        <span class="built_in">this</span>.currentCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (currentTime - windowStart &gt;= windowSizeInMillis) &#123;</span><br><span class="line">            <span class="comment">// 新窗口开始</span></span><br><span class="line">            currentCount = <span class="number">0</span>;</span><br><span class="line">            windowStart = currentTime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentCount &lt; maxRequestsPerWindow) &#123;</span><br><span class="line">            currentCount++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="算法对比"><a href="#算法对比" class="headerlink" title="算法对比"></a>算法对比</h3><table>
<thead>
<tr>
<th>算法</th>
<th>核心优势</th>
<th>缺陷</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>计数器</td>
<td>实现简单</td>
<td>临界值问题</td>
<td>低频验证码</td>
</tr>
<tr>
<td>滑动窗口</td>
<td>精度高</td>
<td>计算复杂度高</td>
<td>API接口QPS限制</td>
</tr>
<tr>
<td>令牌桶</td>
<td>支持突发流量</td>
<td>需要维护令牌池</td>
<td>秒杀、直播等高并发</td>
</tr>
<tr>
<td>漏桶</td>
<td>强制平滑输出</td>
<td>无法应对突发流量</td>
<td>API网关流量整形</td>
</tr>
</tbody></table>
<h2 id="SpringBoot集成"><a href="#SpringBoot集成" class="headerlink" title="SpringBoot集成"></a>SpringBoot集成</h2><ul>
<li>GuavaRateLimiter</li>
<li>Resilience4j</li>
<li>RedisRateLimiter</li>
<li>SlidingWindowRateLimiter</li>
</ul>
<h3 id="定义配置项与类型"><a href="#定义配置项与类型" class="headerlink" title="定义配置项与类型"></a>定义配置项与类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- RateLimiterProperties</span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;rate-limiter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 是否启用限流功能</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 默认限流类型: GUAVA, REDIS, RESILIENCE4J, SLIDING_WINDOW</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">defaultType</span> <span class="operator">=</span> RateLimiterType.GUAVA.name();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 默认每个时间窗口允许的请求数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">defaultPermits</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 默认时间窗口大小（秒）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">defaultTimeWindowSeconds</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 限流触发时的默认响应消息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">defaultMessage</span> <span class="operator">=</span> <span class="string">&quot;请求过于频繁，请稍后再试&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自定义接口限流配置</span></span><br><span class="line"><span class="comment">   * Key 是 API 路径或方法名，Value 是限流配置</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, ApiRateLimit&gt; apis = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Setter</span></span><br><span class="line">  <span class="meta">@Getter</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ApiRateLimit</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="keyword">permits</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> timeWindowSeconds;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>RateLimiterType</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RateLimiterType</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 基于Guava的RateLimiter</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  GUAVA,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 基于Redis的分布式限流器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  REDIS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 基于Resilience4j的限流器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  RESILIENCE4J,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自定义滑动窗口限流器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SLIDING_WINDOW</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="AutoConfiguration"><a href="#AutoConfiguration" class="headerlink" title="AutoConfiguration"></a>AutoConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CustomerRateLimiter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;rate-limiter&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">        matchIfMissing = true)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RateLimiterProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123;RateLimiterRedisConfiguration.class, RateLimiterResilience4jConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.ares.factory.ratelimt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> RateLimiterFactory <span class="title function_">rateLimiterFactory</span><span class="params">(RateLimiterProperties properties,</span></span><br><span class="line"><span class="params">            StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RateLimiterFactory</span>(properties, redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> RateLimitAspect <span class="title function_">rateLimitAspect</span><span class="params">(RateLimiterFactory rateLimiterFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RateLimitAspect</span>(rateLimiterFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RateLimiterRegistry.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterResilience4jConfiguration</span> &#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">  <span class="keyword">public</span> RateLimiterRegistry <span class="title function_">rateLimiterRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RateLimiterRegistry.ofDefaults();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(StringRedisTemplate.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterRedisConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">  <span class="meta">@ConditionalOnBean(RedisConnectionFactory.class)</span></span><br><span class="line">  <span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(connectionFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RateLimiterFactory"><a href="#RateLimiterFactory" class="headerlink" title="RateLimiterFactory"></a>RateLimiterFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CustomRateLimiter&gt; rateLimiterCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> RateLimiterProperties properties;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RateLimiterFactory</span><span class="params">(RateLimiterProperties properties,</span></span><br><span class="line"><span class="params">      StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.properties = properties;</span><br><span class="line">    <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据限流注解创建相应的限流器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> CustomRateLimiter <span class="title function_">createRateLimiter</span><span class="params">(RateLimiter rateLimit, String fallbackKey)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> rateLimit.key().isEmpty() ? fallbackKey : rateLimit.key();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rateLimiterCache.computeIfAbsent(key, v -&gt; &#123;</span><br><span class="line">      <span class="type">RateLimiterType</span> <span class="variable">type</span> <span class="operator">=</span> rateLimit.type();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果配置了该key的特定配置，则应用配置</span></span><br><span class="line">      <span class="keyword">if</span> (properties.getApis().containsKey(key)) &#123;</span><br><span class="line"></span><br><span class="line">        RateLimiterProperties.<span class="type">ApiRateLimit</span> <span class="variable">apiConfig</span> <span class="operator">=</span> properties.getApis().get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apiConfig.getType() != <span class="literal">null</span>) &#123;</span><br><span class="line">          type = RateLimiterType.valueOf(apiConfig.getType());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">permits</span> <span class="operator">=</span> apiConfig.getPermits() &gt; <span class="number">0</span> ? apiConfig.getPermits() : rateLimit.<span class="keyword">permits</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeWindow</span> <span class="operator">=</span> apiConfig.getTimeWindowSeconds() &gt; <span class="number">0</span> ? apiConfig.getTimeWindowSeconds()</span><br><span class="line">            : (<span class="type">int</span>) rateLimit.timeUnit().toSeconds(rateLimit.timeWindow());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">          <span class="keyword">case</span> REDIS -&gt; createRedisRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">          <span class="keyword">case</span> RESILIENCE4J -&gt; createResilience4jRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">          <span class="keyword">case</span> SLIDING_WINDOW -&gt; createSlidingWindowRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">          <span class="keyword">default</span> -&gt; createGuavaRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 否则使用注解上的配置</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> REDIS -&gt; createRedisRateLimiter(rateLimit);</span><br><span class="line">        <span class="keyword">case</span> RESILIENCE4J -&gt; createResilience4jRateLimiter(rateLimit);</span><br><span class="line">        <span class="keyword">case</span> SLIDING_WINDOW -&gt; createSlidingWindowRateLimiter(rateLimit);</span><br><span class="line">        <span class="keyword">default</span> -&gt; createGuavaRateLimiter(rateLimit);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从配置中创建限流器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> CustomRateLimiter <span class="title function_">createRateLimiterFromProperties</span><span class="params">(String key)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">RateLimiterType</span> <span class="variable">type</span> <span class="operator">=</span> RateLimiterType.valueOf(properties.getDefaultType());</span><br><span class="line">    <span class="type">int</span> <span class="variable">permits</span> <span class="operator">=</span> properties.getDefaultPermits();</span><br><span class="line">    <span class="type">int</span> <span class="variable">timeWindow</span> <span class="operator">=</span> properties.getDefaultTimeWindowSeconds();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (properties.getApis().containsKey(key)) &#123;</span><br><span class="line">      RateLimiterProperties.<span class="type">ApiRateLimit</span> <span class="variable">apiConfig</span> <span class="operator">=</span> properties.getApis().get(key);</span><br><span class="line">      <span class="keyword">if</span> (apiConfig.getType() != <span class="literal">null</span>) &#123;</span><br><span class="line">        type = RateLimiterType.valueOf(apiConfig.getType());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (apiConfig.getPermits() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">permits</span> = apiConfig.getPermits();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (apiConfig.getTimeWindowSeconds() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        timeWindow = apiConfig.getTimeWindowSeconds();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> REDIS -&gt; createRedisRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">      <span class="keyword">case</span> RESILIENCE4J -&gt; createResilience4jRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">      <span class="keyword">case</span> SLIDING_WINDOW -&gt; createSlidingWindowRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">      <span class="keyword">default</span> -&gt; createGuavaRateLimiter(<span class="keyword">permits</span>, timeWindow);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createGuavaRateLimiter</span><span class="params">(RateLimiter rateLimiter)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">permitsPerSecond</span> <span class="operator">=</span> calculatePermitsPerSecond(rateLimiter);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GuavaRateLimiter</span>(permitsPerSecond);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createGuavaRateLimiter</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">int</span> timeWindowSeconds)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">permitsPerSecond</span> <span class="operator">=</span> (<span class="type">double</span>) <span class="keyword">permits</span> / timeWindowSeconds;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GuavaRateLimiter</span>(permitsPerSecond);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createRedisRateLimiter</span><span class="params">(RateLimiter rateLimit)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stringRedisTemplate == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Redis template is not available for Redis rate limiter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">windowSeconds</span> <span class="operator">=</span> (<span class="type">int</span>) rateLimit.timeUnit().toSeconds(rateLimit.timeWindow());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisRateLimiter</span>(stringRedisTemplate, rateLimit.<span class="keyword">permits</span>(), windowSeconds);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createRedisRateLimiter</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">int</span> timeWindowSeconds)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stringRedisTemplate == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Redis template is not available for Redis rate limiter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisRateLimiter</span>(stringRedisTemplate, <span class="keyword">permits</span>, timeWindowSeconds);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createResilience4jRateLimiter</span><span class="params">(RateLimiter rateLimit)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Resilience4jRateLimiter</span>(</span><br><span class="line">        rateLimit.<span class="keyword">permits</span>(),</span><br><span class="line">        rateLimit.timeWindow(),</span><br><span class="line">        rateLimit.timeUnit());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createResilience4jRateLimiter</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">int</span> timeWindowSeconds)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Resilience4jRateLimiter</span>(</span><br><span class="line">        <span class="keyword">permits</span>,</span><br><span class="line">        timeWindowSeconds,</span><br><span class="line">        TimeUnit.SECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createSlidingWindowRateLimiter</span><span class="params">(RateLimiter rateLimit)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SlidingWindowRateLimiter</span>(</span><br><span class="line">        rateLimit.<span class="keyword">permits</span>(),</span><br><span class="line">        rateLimit.timeWindow(),</span><br><span class="line">        rateLimit.timeUnit());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CustomRateLimiter <span class="title function_">createSlidingWindowRateLimiter</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">int</span> timeWindowSeconds)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SlidingWindowRateLimiter</span>(</span><br><span class="line">        <span class="keyword">permits</span>,</span><br><span class="line">        timeWindowSeconds,</span><br><span class="line">        TimeUnit.SECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculatePermitsPerSecond</span><span class="params">(RateLimiter rateLimit)</span> &#123;</span><br><span class="line">    <span class="comment">// 将配置的时间窗口和许可数转换为每秒许可数</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">timeWindowInSeconds</span> <span class="operator">=</span> rateLimit.timeUnit().toSeconds(rateLimit.timeWindow());</span><br><span class="line">    <span class="keyword">if</span> (timeWindowInSeconds == <span class="number">0</span>) &#123;</span><br><span class="line">      timeWindowInSeconds = <span class="number">1</span>; <span class="comment">// 防止除零</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">double</span>) rateLimit.<span class="keyword">permits</span>() / timeWindowInSeconds;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CustomRateLimiter-接口与实现"><a href="#CustomRateLimiter-接口与实现" class="headerlink" title="CustomRateLimiter 接口与实现"></a>CustomRateLimiter 接口与实现</h3><h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CustomRateLimiter</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 尝试获取许可</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key 限流标识</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 是否获取成功</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 释放许可（如需要）</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key 限流标识</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="comment">// 默认空实现</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><ul>
<li>SlidingWindowRateLimiter实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">CustomRateLimiter</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Queue&lt;Long&gt;&gt; windowMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxPermits;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> windowMillis;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">int</span> maxPermits, <span class="type">int</span> timeWindow, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">    <span class="built_in">this</span>.windowMillis = timeUnit.toMillis(timeWindow);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> Instant.now().toEpochMilli();</span><br><span class="line">    Queue&lt;Long&gt; window = windowMap.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;());</span><br><span class="line">    <span class="comment">// 清理过期的时间戳</span></span><br><span class="line">    <span class="keyword">while</span> (!window.isEmpty() &amp;&amp; currentTime - window.peek() &gt; windowMillis) &#123;</span><br><span class="line">      window.poll();</span><br><span class="line">    &#125; <span class="comment">// 判断是否超过限制</span></span><br><span class="line">    <span class="keyword">if</span> (window.size() &lt; maxPermits) &#123;</span><br><span class="line">      window.offer(currentTime);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Resilience4jRateLimiter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Resilience4jRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">CustomRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RateLimiter&gt; limiters = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> limitForPeriod;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> timeWindow;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Resilience4jRateLimiter</span><span class="params">(<span class="type">int</span> limitForPeriod, <span class="type">int</span> timeWindow, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">    <span class="built_in">this</span>.timeWindow = timeWindow;</span><br><span class="line">    <span class="built_in">this</span>.limitForPeriod = limitForPeriod;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> limiters.computeIfAbsent(key, v -&gt; &#123;</span><br><span class="line">      <span class="type">RateLimiterConfig</span> <span class="variable">config</span> <span class="operator">=</span> RateLimiterConfig.custom()</span><br><span class="line">          .limitForPeriod(limitForPeriod)</span><br><span class="line">          .limitRefreshPeriod(Duration.ofMillis(timeUnit.toMillis(timeWindow)))</span><br><span class="line">          .timeoutDuration(Duration.ofMillis(<span class="number">0</span>)) <span class="comment">// 非阻塞</span></span><br><span class="line">          .build();</span><br><span class="line">      <span class="keyword">return</span> RateLimiterRegistry.of(config).rateLimiter(key);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter.acquirePermission();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>RedisRateLimiter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">CustomRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxPermits;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> windowSeconds;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_SCRIPT</span> <span class="operator">=</span></span><br><span class="line">      <span class="string">&quot;local key = KEYS[1] &quot;</span> +</span><br><span class="line">          <span class="string">&quot;local currentCount = redis.call(&#x27;incr&#x27;, key) &quot;</span> +</span><br><span class="line">          <span class="string">&quot;if tonumber(currentCount) == 1 then &quot;</span> +</span><br><span class="line">          <span class="string">&quot;    redis.call(&#x27;expire&#x27;, key, ARGV[1]) &quot;</span> +</span><br><span class="line">          <span class="string">&quot;end &quot;</span> +</span><br><span class="line">          <span class="string">&quot;return currentCount &lt;= tonumber(ARGV[2])&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RedisRateLimiter</span><span class="params">(StringRedisTemplate stringRedisTemplate, <span class="type">int</span> maxPermits,</span></span><br><span class="line"><span class="params">      <span class="type">int</span> windowSeconds)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">    <span class="built_in">this</span>.windowSeconds = windowSeconds;</span><br><span class="line">    <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    DefaultRedisScript&lt;Boolean&gt; script = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(REDIS_SCRIPT, Boolean.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span></span><br><span class="line">        stringRedisTemplate.execute(script, Collections.singletonList(<span class="string">&quot;rate:limit:&quot;</span> + key),</span><br><span class="line">            String.valueOf(windowSeconds), String.valueOf(maxPermits));</span><br><span class="line">    <span class="keyword">return</span> result != <span class="literal">null</span> &amp;&amp; result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>GuavaRateLimiter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuavaRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">CustomRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RateLimiter&gt; limiters = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> permitsPerSecond;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">GuavaRateLimiter</span><span class="params">(<span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.permitsPerSecond = permitsPerSecond;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span></span><br><span class="line">        limiters.computeIfAbsent(key, k -&gt; RateLimiter.create(permitsPerSecond));</span><br><span class="line">    <span class="keyword">return</span> rateLimiter.tryAcquire();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RateLimiter注解实现"><a href="#RateLimiter注解实现" class="headerlink" title="RateLimiter注解实现"></a>RateLimiter注解实现</h3><ul>
<li>@RateLimiter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RateLimiter &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 限流唯一标识，默认为方法全限定名</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  String <span class="title function_">key</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 限流策略，支持不同类型的限流器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  RateLimiterType <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> RateLimiterType.GUAVA;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 限流时间窗口</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">timeWindow</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 时间单位</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  TimeUnit <span class="title function_">timeUnit</span><span class="params">()</span> <span class="keyword">default</span> TimeUnit.SECONDS;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在时间窗口内允许通过的请求数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">permits</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取令牌最大等待时间，0表示非阻塞</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">long</span> <span class="title function_">timeout</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 触发限流时的提示消息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;请求过于频繁，请稍后再试&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>RateLimiterAspect</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterAspect</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> RateLimiterProperties properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> RateLimiterFactory rateLimiterFactory;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RateLimiterAspect</span><span class="params">(RateLimiterProperties properties,</span></span><br><span class="line"><span class="params">      RateLimiterFactory rateLimiterFactory)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.properties = properties;</span><br><span class="line">    <span class="built_in">this</span>.rateLimiterFactory = rateLimiterFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around(&quot;@annotation(com.ares.ratelimiter.annotation.RateLimiter)&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">rateLimit</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!properties.isEnabled()) &#123;</span><br><span class="line">      <span class="keyword">return</span> point.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) point.getSignature();</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line"></span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimit</span> <span class="operator">=</span> method.getAnnotation(RateLimiter.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getDeclaringClass().getName() + <span class="string">&quot;.&quot;</span> + method.getName();</span><br><span class="line">    <span class="type">CustomRateLimiter</span> <span class="variable">limiter</span> <span class="operator">=</span> rateLimiterFactory.createRateLimiter(rateLimit, methodName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (limiter.tryAcquire(methodName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> point.proceed();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取自定义消息或使用默认消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> rateLimit.message();</span><br><span class="line">        <span class="keyword">if</span> (message.isEmpty()) &#123;</span><br><span class="line">          message = properties.getDefaultMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (properties.getApis().containsKey(methodName)</span><br><span class="line">            &amp;&amp; properties.getApis().get(methodName).getMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">          message = properties.getApis().get(methodName).getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ResponseStatusException</span>(HttpStatus.TOO_MANY_REQUESTS, message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      limiter.release(methodName); <span class="comment">// 如果有需要释放的资源</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="待优化扩展方向"><a href="#待优化扩展方向" class="headerlink" title="待优化扩展方向"></a>待优化扩展方向</h3><ul>
<li>动态配置</li>
<li>支持多级限流</li>
<li>支持降级处理</li>
<li>支持用户级别或IP级别限流</li>
<li>限流指标监控</li>
</ul>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a>, <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>, <a href="/categories/%E9%AB%98%E5%8F%AF%E7%94%A8/">高可用</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>, <a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">高可用</a>
  </div>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="as_sitesearch" value="example.com">
  </form>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AOP/">AOP</a><small>2</small></li>
  
    <li><a href="/categories/IOC/">IOC</a><small>1</small></li>
  
    <li><a href="/categories/JPA/">JPA</a><small>3</small></li>
  
    <li><a href="/categories/Java/">Java</a><small>11</small></li>
  
    <li><a href="/categories/ORM/">ORM</a><small>3</small></li>
  
    <li><a href="/categories/juc/">juc</a><small>7</small></li>
  
    <li><a href="/categories/log/">log</a><small>2</small></li>
  
    <li><a href="/categories/mysql/">mysql</a><small>2</small></li>
  
    <li><a href="/categories/redis/">redis</a><small>1</small></li>
  
    <li><a href="/categories/spring/">spring</a><small>9</small></li>
  
    <li><a href="/categories/spring-boot/">spring-boot</a><small>9</small></li>
  
    <li><a href="/categories/spring-data/">spring-data</a><small>3</small></li>
  
    <li><a href="/categories/%E4%BA%8B%E5%8A%A1/">事务</a><small>2</small></li>
  
    <li><a href="/categories/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">动态代理</a><small>2</small></li>
  
    <li><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><small>4</small></li>
  
    <li><a href="/categories/%E5%B9%B6%E5%8F%91/">并发</a><small>9</small></li>
  
    <li><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a><small>1</small></li>
  
    <li><a href="/categories/%E7%BA%BF%E7%A8%8B%E6%B1%A0/">线程池</a><small>4</small></li>
  
    <li><a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a><small>3</small></li>
  
    <li><a href="/categories/%E9%94%81/">锁</a><small>1</small></li>
  
    <li><a href="/categories/%E9%AB%98%E5%8F%AF%E7%94%A8/">高可用</a><small>1</small></li>
  
    <li><a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD/">高性能</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/AOP/">AOP</a><small>2</small></li>
  
    <li><a href="/tags/IOC/">IOC</a><small>1</small></li>
  
    <li><a href="/tags/JPA/">JPA</a><small>3</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>11</small></li>
  
    <li><a href="/tags/ORM/">ORM</a><small>1</small></li>
  
    <li><a href="/tags/juc/">juc</a><small>7</small></li>
  
    <li><a href="/tags/log/">log</a><small>2</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>2</small></li>
  
    <li><a href="/tags/redis/">redis</a><small>1</small></li>
  
    <li><a href="/tags/spring/">spring</a><small>9</small></li>
  
    <li><a href="/tags/spring-boot/">spring-boot</a><small>9</small></li>
  
    <li><a href="/tags/spring-data/">spring-data</a><small>3</small></li>
  
    <li><a href="/tags/%E4%BA%8B%E5%8A%A1/">事务</a><small>2</small></li>
  
    <li><a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">动态代理</a><small>2</small></li>
  
    <li><a href="/tags/%E5%B9%B6%E5%8F%91/">并发</a><small>9</small></li>
  
    <li><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a><small>1</small></li>
  
    <li><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/">线程池</a><small>4</small></li>
  
    <li><a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a><small>3</small></li>
  
    <li><a href="/tags/%E9%94%81/">锁</a><small>1</small></li>
  
    <li><a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">高可用</a><small>1</small></li>
  
    <li><a href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD/">高性能</a><small>2</small></li>
  
  </ul>
</div>


  
  <div class="widget widget-archives">
    <h3 class="title">归档</h3>
    <div class="entry">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">七月 2025</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a><span class="archive-list-count">17</span></li></ul>
    </div>
  </div>


</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2025 ares
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script>
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
